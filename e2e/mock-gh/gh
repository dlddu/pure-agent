#!/bin/sh
# mock-gh — a drop-in replacement for the gh CLI used in e2e tests.
#
# Supported commands:
#   gh pr create [flags]       → records args to GH_CALLS_DIR, prints fake PR URL
#   gh auth status             → exits 0
#   gh api repos/<org>/<repo>  → prints {"permissions":{"push":true}}
#   anything else              → exits 1 with error message

set -eu

: "${GH_CALLS_DIR:=/tmp/gh-calls}"
mkdir -p "$GH_CALLS_DIR"

if [ $# -eq 0 ]; then
  echo "mock-gh: no command given" >&2
  exit 1
fi

command="$1"
subcommand="${2:-}"

case "$command" in
  pr)
    case "$subcommand" in
      create)
        # Record all arguments to a timestamped file
        local_file="$GH_CALLS_DIR/pr-create-$(date +%s%N).txt"
        echo "gh pr create $*" > "$local_file"
        # Also store each --flag value pair for easier assertions
        shift 2
        while [ $# -gt 0 ]; do
          echo "$1" >> "$local_file"
          shift
        done
        # Print a fake PR URL
        echo "https://github.com/mock-org/mock-repo/pull/1"
        ;;
      *)
        echo "mock-gh: unknown pr subcommand: '$subcommand'" >&2
        exit 1
        ;;
    esac
    ;;

  auth)
    case "$subcommand" in
      status)
        echo "Logged in to github.com as mock-user (mock-gh)"
        ;;
      setup-git)
        # no-op: mock does not need to configure git credential helper
        ;;
      *)
        echo "mock-gh: unknown auth subcommand: '$subcommand'" >&2
        exit 1
        ;;
    esac
    ;;

  api)
    path="${subcommand}"
    shift 2  # skip "api" and path

    # Check for --jq flag
    jq_filter=""
    while [ $# -gt 0 ]; do
      case "$1" in
        --jq) jq_filter="$2"; shift 2 ;;
        *) shift ;;
      esac
    done

    case "$path" in
      repos/*)
        output='{"permissions":{"push":true}}'
        ;;
      *)
        echo "mock-gh: unknown api path: '$path'" >&2
        exit 1
        ;;
    esac

    if [ -n "$jq_filter" ]; then
      # Handle known jq filters without requiring jq binary
      case "$jq_filter" in
        .permissions.push)
          echo "true"
          ;;
        *)
          # Fallback: try jq if available, otherwise output raw
          if command -v jq >/dev/null 2>&1; then
            echo "$output" | jq -r "$jq_filter"
          else
            echo "$output"
          fi
          ;;
      esac
    else
      echo "$output"
    fi
    ;;

  *)
    echo "mock-gh: unknown command: '$command'" >&2
    exit 1
    ;;
esac
